{% extends '../base.html' %}  <!-- Extends the base template -->
{% load static %}  <!-- Loads static files for images, CSS, etc. -->

{% block title %} Profile {% endblock %}  <!-- Sets the page title -->
{% block content %}

<div class="wrapper">



  <!-- Main Sidebar Container -->
 {% include 'Side_Navbar.html' %}

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>Profile</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item active">User Profile</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-md-3">

            <!-- Profile Image -->
            <div class="card card-primary card-outline">
              <div class="card-body box-profile">
            <div class="text-center">
                  {% if employee.profile_picture %}
                    <img
                      class="profile-user-img img-fluid img-circle"
                      src="{{ employee.profile_picture.url }}"
                      alt="User profile picture"
                      style="cursor: pointer;"
                      data-bs-toggle="modal"
                      data-bs-target="#profileImageModal"
                    >
                  {% else %}
                    <img
                      class="profile-user-img img-fluid img-circle"
                      src="{% static 'img/Damy.webp' %}"
                      alt="User profile picture"
                      style="cursor: pointer;"
                      data-bs-toggle="modal"
                      data-bs-target="#profileImageModal"
                    >
                  {% endif %}
                </div>
                <!--Modal for profile image-->
                <div class="modal fade" id="profileImageModal" tabindex="-1" aria-labelledby="profileImageModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content bg-transparent border-0">
                  <div class="modal-body text-center">
                  {% if employee.profile_picture %}
                    <img
                      src="{{ employee.profile_picture.url }}"
                      alt="Profile Large"
                      class="img-fluid rounded"

                    >
                  {% else %}
                    <img
                      src="{% static 'img/Damy.webp' %}"
                      alt="Default Profile"
                      class="img-fluid rounded"
                    >
                  {% endif %}
                </div>
                    </div>
                  </div>
                </div>


                <h3 class="profile-username text-center">{{employee.name}}</h3>

                <p class="text-muted text-center">{{employee.department.name}}</p>
                    <!-- Upper Employee Info UL -->
                    <ul id="employee-info" class="list-group list-group-unbordered mb-3">
                      <li class="list-group-item d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <b>Designation</b>
                        <span class="text-right text-wrap">{{ employee.designation.title }}</span>
                      </li>
                      <li class="list-group-item d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <b>Role</b>
                        <span class="text-right text-wrap">{{ employee.role }}</span>
                      </li>
                      <li class="list-group-item d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <b>Date of Joining</b>
                        <span class="text-right text-wrap">{{ employee.date_of_join }}</span>
                      </li>
                    </ul>

                    <!-- Leave Info UL (Initially Hidden) -->
                    <ul id="leave-info" class="list-group list-group-unbordered mb-3 d-none">
                      <li class="list-group-item d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <b>Total Leave</b>
                        <span class="text-right text-wrap">{{ total_leave.total_leave_sum }}</span>
                      </li>
                      <li class="list-group-item d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <b>Remaining Leave</b>
                        <span class="text-right text-wrap">{{ total_leave.remaining_leave_sum}}</span>
                      </li>
                      <li class="list-group-item d-flex justify-content-between align-items-start flex-column flex-sm-row">
                        <b>Availed Leave</b>
                        <span class="text-right text-wrap">{{ total_leave.availed_leave_sum }}</span>
                      </li>
                    </ul>

              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->

            <!-- About Me Box -->
                <div class="card card-primary" >
               <div class="card-header d-flex align-items-center">
                  <h3 class="card-title mb-0">About Me</h3>

                  <!-- Edit Button -->
                   {% if request.session.employee_name == employee.name %}
                  <button class="btn btn-sm btn-primary ms-auto" data-toggle="modal" data-target="#editModal">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                     {% endif %}
                </div>


                  <div class="card-body">

                    <!-- Phone -->
                    <div class="mb-3">
                      <strong><i class="fas fa-book mr-1"></i> Phone</strong>
                      <p class="text-muted mb-0">{{ employee.phone_number |default:"-"}}</p>
                    </div>
                    <hr>

                    <!-- Email -->
                    <div class="mb-3">
                      <strong><i class="fas fa-map-marker-alt mr-1"></i> Email</strong>
                      <p class="text-muted mb-0" style="word-wrap: break-word; white-space: normal;">
                        {{ employee.email }}
                      </p>
                    </div>
                    <hr>

                    <!-- Birthday -->
                    <div class="mb-3">
                      <strong><i class="fas fa-pencil-alt mr-1"></i> Birthday</strong>
                      <p class="text-muted mb-0"><span class="badge badge-danger">{{ employee.dob |default:"-" }}</span></p>
                    </div>
                    <hr>

                    <!-- Address -->
                    <div class="mb-3">
                      <strong><i class="far fa-file-alt mr-1"></i> Address</strong>
                      <p class="text-muted mb-0">{{ employee.current_address }}</p>
                    </div>
                    <hr>

                    <!-- Gender -->
                    <div class="mb-3">
                      <strong><i class="far fa-file-alt mr-1"></i> Gender</strong>
                      <p class="text-muted mb-0">{{ employee.gender |default:"-" }}</p>
                    </div>
                    <hr>

                   <!-- Reported to -->
                    {% if employee.role != 'Administrator' %}
                    <div class="mb-3">
                      <strong><i class="far fa-file-alt mr-1"></i> Reported to</strong>
                      <div class="d-flex align-items-center mt-2">
                        {% if employee.reported_to.profile_picture %}
                          <img
                            src="{{ employee.reported_to.profile_picture.url }}"
                            alt="Profile"
                            class="rounded-circle"
                            style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;"
                          >
                        {% else %}
                          <img
                            src="{% static 'img/Damy.webp' %}"
                            alt="Default Profile"
                            class="rounded-circle"
                            style="width: 50px; height: 50px; object-fit: cover; margin-right: 10px;"
                          >
                        {% endif %}
                        <p class="mb-0">{{ employee.reported_to.name|default:"Not Assigned" }}</p>
                      </div>
                    </div>
                    {% endif %}


                  </div>
                </div>

        </div>
          <!-- /.col -->
          <div class="col-md-9">
            <div class="card" >
              <div class="card-header p-2">
                <ul class="nav nav-pills">
                <li class="nav-item"><a class="nav-link  text-white" href="#activity" data-toggle="tab">Details</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="#document" data-toggle="tab">Document</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="#timesheet" data-toggle="tab">Timesheet</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="#leave" data-toggle="tab">Leave</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="#project" data-toggle="tab">Project</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="#task" data-toggle="tab">Task</a></li>
                <li class="nav-item"><a class="nav-link text-white" href="#assests" data-toggle="tab">Assets</a></li>

                </ul>
              </div><!-- /.card-header -->
              <div class="card-body">
                <div class="tab-content ">
                <div  id="activity" style="max-height: 600px; overflow-y: auto;">
                    <div class="row">

                        <!-- Personal Information Card -->
                        <div class="col-12 mb-4">
                            <div class="card card-primary h-100">
                                <div class="card-header d-flex justify-content-between">
                                    <h3 class="card-title">Personal Information</h3>
                                    <button class="btn btn-sm btn-primary ml-auto" data-toggle="modal" data-target="#PersonaleditModal">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                </div>
                                <div class="card-body">
                                    <!-- Passport -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong><i class="fas fa-passport mr-1"></i> Passport:</strong>
                                        <p class="text-muted mb-0">{{ personalDetails.passport }}</p>
                                    </div>
                                    <hr>

                                    <!-- Passport No. -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong><i class="fas fa-id-card mr-1"></i> Passport No.:</strong>
                                        <p class="text-muted mb-0 text-right" style="flex-grow: 1;">{{ personalDetails.passport_number }}</p>
                                    </div>
                                    <hr>

                                    <!-- Telephone -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong><i class="fas fa-phone-alt mr-1"></i> Tel.:</strong>
                                        <p class="text-muted mb-0">{{ personalDetails.Tell_number }}</p>
                                    </div>
                                    <hr>

                                    <!-- Religion -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong><i class="fas fa-praying-hands mr-1"></i>Religion:</strong>
                                        <p class="text-muted mb-0">{{ personalDetails.religion }}</p>
                                    </div>
                                    <hr>

                                    <!-- Marital Status -->
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong><i class="fas fa-ring mr-1"></i>Marital Status:</strong>
                                        <p class="text-muted mb-0">{{ personalDetails.marital_status }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End Personal Information -->

                        <!-- Emergency Contact -->
                        <div class="col-12 mb-4">
                            <div class="card card-secondary h-100 " >
                                <div class="card-header d-flex justify-content-between">
                                    <h3 class="card-title">Emergency Contact</h3>
                                    <button class="btn btn-sm btn-secondary ml-auto" data-toggle="modal" data-target="#editAdditionalInfoModal">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                </div>
                                <div class="card-body">
                                    <!-- Primary Contact -->
                                    <div class="mb-4">
                                        <h5 class="text-primary mb-3"><i class="fas fa-user-friends mr-2"></i>Primary Contact</h5>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <strong><i class="fas fa-user mr-1"></i>Name:</strong>
                                            <p class="text-muted mb-0">{{ primary_contact.name|default_if_none:'' }}</p>
                                        </div>
                                        <hr>

                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <strong><i class="fas fa-handshake mr-1"></i>Relationship:</strong>
                                            <p class="text-muted mb-0">{{ primary_contact.relationship|default_if_none:'' }}</p>
                                        </div>
                                        <hr>

                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <strong><i class="fas fa-phone-alt mr-1"></i> Phone:</strong>
                                            <p class="text-muted mb-0">{{ primary_contact.phone_number|default_if_none:'' }}</p>
                                        </div>
                                    </div>

                                    <!-- Secondary Contact -->
                                    <div>
                                        <h5 class="text-danger mb-3"><i class="fas fa-user-friends mr-2"></i>Secondary Contact</h5>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <strong><i class="fas fa-user mr-1"></i> Name:</strong>
                                            <p class="text-muted mb-0">{{ secondary_contact.name|default_if_none:'' }}</p>
                                        </div>
                                        <hr>

                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <strong><i class="fas fa-handshake mr-1"></i> Relationship:</strong>
                                            <p class="text-muted mb-0">{{ secondary_contact.relationship|default_if_none:'' }}</p>
                                        </div>
                                        <hr>

                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <strong><i class="fas fa-phone-alt mr-1"></i> Phone:</strong>
                                            <p class="text-muted mb-0">{{ secondary_contact.phone_number|default_if_none:'' }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End Emergency Contact -->

                        <!-- Bank Details -->
                        <div class="col-12 mb-4">
                            <div class="card card-success h-100">
                                <div class="card-header d-flex justify-content-between">
                                    <h3 class="card-title">Bank information</h3>
                                    <button class="btn btn-sm btn-success ml-auto" data-toggle="modal" data-target="#editBankModal">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong><i class="fas fa-building mr-1"></i> Bank Name:</strong>
                                        <p class="text-muted mb-0">{{ bank_details.bank_name|default:'' }}</p>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong><i class="fas fa-briefcase mr-1"></i> Bank Account No.:</strong>
                                        <p class="text-muted mb-0">{{bank_details.bank_account_no|default:''}}</p>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong><i class="fas fa-briefcase mr-1"></i> IFSC Code:</strong>
                                        <p class="text-muted mb-0">{{bank_details.ifsc_code|default:'' }}</p>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong><i class="fas fa-briefcase mr-1"></i>PAN No:</strong>
                                        <p class="text-muted mb-0">{{ employee.bank_details.pan_no|default:'' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End Bank Details -->

                        <!-- Education Information -->
                        <div class="col-12 mb-4">
                            <div class="card card-warning h-100">
                                <div class="card-header d-flex justify-content-between">
                                    <h3 class="card-title">Education Informations</h3>
                                    <button class="btn btn-sm btn-warning ml-auto" data-toggle="modal" data-target="#editEducationModal">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="timeline">
                                        <!-- Main Timeline Item -->
                                        <div class="timeline-item mb-4 position-relative pl-4">
                                            <div class="timeline-point bg-primary position-absolute"
                                                 style="left: 0; top: 0.5rem; width: 12px; height: 12px; border-radius: 50%;">
                                            </div>

                                            <div class="pl-3">
                                                <strong><i class="fas fa-university mr-1 text-primary"></i> {{Edu.institution_name}}</strong>
                                                <ul class="list-unstyled mt-2 mb-0">
                                                    <li><i class="fas fa-laptop-code mr-1 text-muted"></i><strong>Branch:</strong> {{Edu.branch }}</li>
                                                    <li><i class="fas fa-calendar-alt mr-1 text-muted"></i><strong>Duration:</strong> {{Edu.start_date}} - {{Edu.end_date}}</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End Education Information -->

                           <!-- Experience -->
                            <div class="col-12 mb-4">
                              <div class="card card-danger h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                  <h3 class="card-title mb-0">Experience</h3>
                                  <button class="btn btn-sm btn-danger ml-auto" data-toggle="modal" data-target="#editExperienceModal">
                                    <i class="fas fa-edit"></i> Edit
                                  </button>
                                </div>

                                <div class="card-body">
                                  <ul class="list-unstyled pl-3 position-relative" style="border-left: 2px solid #dee2e6;">

                                    {% for exp in experiences %}
                                    <li class="mb-4 position-relative">
                                      <!-- Timeline Dot -->
                                      <span class="position-absolute"
                                      style="left: -10px; top: 6px; width: 12px; height: 12px;
                                             {% if forloop.first %}
                                               background-color: #28a745; box-shadow: 0 0 0 2px #28a745;
                                             {% else %}
                                               background-color: #dc3545; box-shadow: 0 0 0 2px #dc3545;
                                             {% endif %}
                                             border-radius: 50%; border: 2px solid #fff;">
                                        </span>


                                      <!-- Content -->
                                      <div class="ml-3">
                                        <h5 class="mb-1 font-weight-bold text-dark">{{ exp.company_name }}</h5>
                                        <p class="mb-1 text-muted">
                                          <i class="fas fa-briefcase mr-1"></i>{{ exp.position }}
                                        </p>
                                        <small class="text-muted">
                                          <i class="far fa-calendar-alt mr-1"></i>{{ exp.start_date }} - {{ exp.end_date }}
                                        </small>
                                      </div>
                                    </li>
                                    {% endfor %}

                                  </ul>
                                </div>
                              </div>
                            </div>

                        <!-- End Experience -->
                    </div>
                </div>

                  <!-- Document pane -->
                 <div class="tab-pane" id="document">
                    <!-- Card for document upload -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Documents</h5>
                            <!-- Upload Button aligned to the right -->
                            <button class="btn btn-success ms-auto" data-bs-toggle="modal" data-bs-target="#uploadModal">Upload Document</button>
                        </div>

                        <div class="card-body">
                            <!-- Table for displaying uploaded documents -->
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th scope="col">Document Name</th>
                                        <th scope="col">Upload Date</th>
                                        <th scope="col">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for docx in Document %}
                                  <tr>
                                        <td><a href="{{ docx.file.url }}" target="_blank" class="text-decoration-none text-primary">{{ docx.name }}</a></td>
                                        <td>{{ docx.uploaded_at }}</td>
                                        <td><a href="{{ docx.file.url }}" class="btn btn-primary" download>Download</a></td>
                                    </tr>

                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Upload Document Modal -->
                    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="uploadModalLabel">Upload New Document</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                     <div id="uploadMessages"></div>
                               <form action="{% url 'upload_document' employee.id %}" method="POST" enctype="multipart/form-data" id="uploadDocumentForm">
                                        {% csrf_token %}

                                        <!-- File Input -->
                                        <div class="mb-3">
                                            <label for="documentFile" class="form-label">Select Document</label>
                                            <input type="file" class="form-control" id="documentFile" name="documentFile" required>
                                        </div>

                                        <!-- Submit Button -->
                                        <button type="submit" class="btn btn-primary">Upload</button>
                                    </form>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                  <!-- Document-pane -->

              <!-- Timesheet Pane -->
                    <div class="tab-pane" id="timesheet">
                      <div class="card my-3 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                          <h6 class="m-0">Timesheet Records</h6>

                          <div class="ms-auto">
                            <button onclick="downloadTableAsCSV('timesheetTable')" class="btn btn-sm btn-primary">
                              <i class="fas fa-download"></i> Export CSV
                            </button>
                          </div>
                        </div>

                        <div class="card-body table-responsive"  style="max-height: 650px; overflow-y: auto;">
                          <table id="timesheetTable" class="table table-striped table-bordered">
                            <thead class="thead-light">
                               <tr>
                              <th>Project</th>
                              <th>Task</th>
                              <th>Date</th>
                              <th>Start Time</th>
                              <th>End Time</th>
                              <th>Hours</th>
                              <th>Description</th>
                              <th>Attachment</th>
                            </tr>
                            </thead>
                            <tbody>
                             {% for record in records %}
                              <tr>
                                <td>{{ record.task.project.project_name }}</td>
                                <td>{{ record.task.task_title }}</td>
                                <td>{{ record.date }}</td>
                                <td>{{ record.start_time }}</td>
                                <td>{{ record.end_time }}</td>
                                <td>{{ record.hours }}</td>

                                <!-- Description with a modal trigger -->
                                <td>
                                  {{ record.record_name|truncatewords:3 }}
                                  <a href="#" data-bs-toggle="modal" data-bs-target="#DescModal{{ record.id }}" class="text-decoration-none text-primary">..more</a>
                                </td>

                                <!-- Modal for Full Description -->
                                <div class="modal fade" id="DescModal{{ record.id }}" tabindex="-1" aria-labelledby="descModalLabel{{ record.id }}" aria-hidden="true">
                                  <div class="modal-dialog modal-dialog-centered modal-sm">
                                    <div class="modal-content border-0 shadow-sm rounded-3">
                                      <div class="modal-header bg-light">
                                        <div class="w-100 text-center">
                                          <h6 class="modal-title fw-semibold m-0" id="descModalLabel{{ record.id }}">Full Description</h6>
                                        </div>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                      </div>
                                      <div class="modal-body small">
                                        {{ record.record_name }}
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- Attachment -->
                                {% if record.attachment %}
                                  <td><a href="{{ record.attachment.url }}" target="_blank">View Attachment</a></td>
                                {% else %}
                                  <td>No Attachment</td>
                                {% endif %}
                              </tr>
                            {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                    <!-- End Timesheet Pane -->

             <!-- leave pane -->
            <div class="tab-pane" id="leave">
              <div class="card my-3 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h6 class="m-0">Leave Records</h6>

                  <div class="ms-auto">
                    <button onclick="downloadTableAsCSV('leaveTable')" class="btn btn-sm btn-primary">
                      <i class="fas fa-download"></i> Export CSV
                    </button>
                  </div>
                </div>

                <div class="card-body"  style="max-height: 650px; overflow-y: auto;">
              <table id="leaveTable" class="table table-bordered table-striped">
                <thead>
                    <tr>
                      <th>Leave Type</th>
                      <th>Leave Days</th>
                      <th>Reason</th>
                      <th>Status</th>
                      <th>Apply Date</th>
                      <th>Start Date</th>
                      <th>End Date</th>
                      <th>Action By</th>
                    </tr>

                </thead>
                <tbody>
                {% for employee in employees %}
                  {% for leave in employee.leave_set.all %}
                    <tr>
                      <td>{{ leave.leave_type.name }}</td>
                      <td>{{ leave.leave_days  }}</td>
                      <td>
                          {{ leave.reason|truncatewords:3 }}  <a href="#" data-bs-toggle="modal" data-bs-target="#reasonModal{{ leave.id }}" class="text-decoration-none text-primary">more</a>
                      </td>
                       <!-- Modal for Full Reason -->
                          <div class="modal fade" id="reasonModal{{ leave.id }}" tabindex="-1" aria-labelledby="reasonModalLabel{{ leave.id }}" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-sm">
                              <div class="modal-content border-0 shadow-sm rounded-3">
                                <div class="modal-header bg-light">
                                  <div class="w-100 text-center">
                                  <h6 class="modal-title fw-semibold m-0" id="reasonModalLabel{{ leave.id }}">Full Reason</h6>
                                  </div>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body small">
                                  {{ leave.reason }}
                                </div>
                              </div>
                            </div>
                          </div>
                     <td class="text-center">
                      <div class="dropdown">
                        <button class="btn btn-sm dropdown-toggle
                          {% if leave.status == 'Pending' %} bg-warning text-dark
                          {% elif leave.status == 'Approved' %} bg-success
                          {% elif leave.status == 'Rejected' %} bg-danger
                          {% else %} bg-secondary
                          {% endif %}
                        " type="button" data-bs-toggle="dropdown" aria-expanded="false">
                          {{ leave.status }}
                        </button>

                        <ul class="dropdown-menu">
                          {% if leave.status != 'Withdrawn' %}
                            <li>
                              <a class="dropdown-item text-danger" href="{% url 'withdraw_leave' leave.id %}" onclick="return confirm('Are you sure you want to withdraw this leave?');">
                                <i class="fas fa-user-slash"></i>  Withdraw
                              </a>
                            </li>
                          {% else %}
                            <li>
                              <span class="dropdown-item text-muted">Already Withdrawn</span>
                            </li>
                          {% endif %}
                        </ul>
                      </div>
                      {% if leave.status == 'Rejected' and leave.reject_reason %}
                          <a href="#"
                                   data-bs-toggle="tooltip"
                                   title="{{ leave.reject_reason }}"
                                   data-bs-placement="left">
                                   Reason
                           </a>
                      {% endif %}
                    </td>

                      <td>{{leave.apply_date}}</td>
                      <td>{{ leave.start_date }}</td>
                      <td>{{ leave.end_date }}</td>
                      <td>
                            {% if leave.approved_by %}
                                {{ leave.approved_by.name }}
                            {% else %}

                            {% endif %}
                        </td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="12" class="text-center">No leave records for {{ employee.name }}</td>
                    </tr>
                  {% endfor %}
                {% endfor %}
                </tbody>
              </table>
              </div>
              </div>
            </div>
            <!-- End leave pane -->


                 <!-- project pane-->
                <div class="tab-pane" id="project">
                  <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">Project Details</h5>
                      <div class="ms-auto">
                      <button onclick="downloadTableAsCSV('proTable')" class="btn btn-sm btn-primary">
                        <i class="fas fa-download"></i> Export CSV
                      </button>
                      </div>
                    </div>

                    <div class="card-body table-responsive"  style="max-height: 650px; overflow-y: auto;" >
                      <table  id="proTable" class="table table-striped table-bordered">
                        <thead class="thead-light">
                          <tr>
                            <th>Project Name</th>
                            <th>Client</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Status</th>
                            <th>Team Lead</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for project in projects %}
                          <tr>
                            <td>{{ project.project_name  }}</td>
                            <td>{{ project.client_name }}</td>
                            <td>{{ project.start_date }}</td>
                            <td>{{ project.end_date }}</td>
                            <td>
                              <span class="badge
                                {% if project.status == 'Ongoing' %} bg-warning
                                {% elif project.status == 'Completed' %} bg-success
                                {% elif project.status == 'On Hold' %} bg-secondary
                                {% else %} bg-danger {% endif %}">
                                {{ project.status }}
                              </span>
                            </td>
                               <td>{{ project.leader.name }}</td>
                          </tr>
                          {% empty %}
                          <tr>
                            <td colspan="6" class="text-center text-muted">No projects found.</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <!--End project pane-->

           <!-- task pane-->
                <div class="tab-pane" id="task">
                  <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">Task Records</h5>
                        <div class="ms-auto">
                      <button onclick="downloadTableAsCSV('tasTable')" class="btn btn-sm btn-primary">
                        <i class="fas fa-download"></i> Export CSV
                      </button>
                        </div>
                    </div>

                    <div class="card-body table-responsive"  style="max-height: 650px; overflow-y: auto;">
                      <table class="table table-bordered table-striped" id="tasTable">
                        <thead class="thead-light">
                          <tr>
                            <th>Task Title</th>
                            <th>Project</th>
                            <th>Assigned To</th>
                            <th>Status</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Priority</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for task in tasks %}
                          <tr>
                            <td>{{ task.task_title }}</td>
                            <td>{{ task.project.project_name }}</td>
                            <td>{{ task.assigned_to.name }}</td>
                            <td>
                              <span class="badge
                                {% if task.status == 'Pending' %} bg-warning
                                {% elif task.status == 'In Progress' %} bg-info
                                {% elif task.status == 'Completed' %} bg-success
                                {% else %} bg-secondary {% endif %}">
                                {{ task.status }}
                              </span>
                            </td>
                            <td>{{ task.start_date }}</td>
                            <td>{{ task.end_date }}</td>
                            <td>
                              <span class="badge
                                {% if task.priority == 'High' %} bg-danger
                                {% elif task.priority == 'Medium' %} bg-warning
                                {% else %} bg-success {% endif %}">
                                {{ task.priority }}
                              </span>
                            </td>
                          </tr>
                          {% empty %}
                          <tr>
                            <td colspan="7" class="text-center text-muted">No task records available.</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <!--End task pane-->

             <!-- assets pane-->
                <div class="tab-pane" id="assests">
                  <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">Assets Records</h5>
                         <div class="ms-auto">
                      <button onclick="downloadTableAsCSV('assetsTable')" class="btn btn-sm btn-primary">
                        <i class="fas fa-download"></i> Export CSV
                      </button>
                         </div>
                    </div>

                    <div class="card-body table-responsive"  style="max-height: 650px; overflow-y: auto;">
                      <table class="table table-bordered table-striped" id="assetsTable">
                        <thead class="thead-light">
                          <tr>
                            <th>Asset Class</th>
                              <th>Asset ID</th>
                              <th>Asset Name</th>
                              <th>Cost</th>
                              <th>Purchase Date</th>
                              <th>Given Date</th>

                          </tr>
                        </thead>
                        <tbody>
                          {% for asset in assets %}
                          <tr>
                       <td>{{ asset.asset_class|default:"-" }}</td>
                        <td>{{ asset.asset_id|default:"-" }}</td>
                        <td>{{ asset.asset_name|default:"-" }}</td>
                        <td>{{ asset.asset_cost|default:"0.00" }}</td>
                        <td>{{ asset.purchase_date|date:"M d, Y"|default:"N/A" }}</td>
                        <td>{{ asset.given_date|date:"M d, Y"|default:"N/A" }}</td>
                          </tr>
                          {% empty %}
                          <tr>
                            <td colspan="6" class="text-center text-muted">No asset records available.</td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <!--End assets pane-->


                </div>
                <!-- /.tab-content -->
              </div><!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->

      <!-- Modal for About me-->
      <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
              <div class="modal-content">
                  <div class="modal-header">
                      <h5 class="modal-title" id="editModalLabel">Edit About Me</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                      </button>
                  </div>
                  <div class="modal-body">
                      <!-- Edit Form -->
                  <form id="editForm" method="POST" action="{% url 'update_about_me' employee.id %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="phone_number">Phone</label>
                        <input type="text" class="form-control" id="phone_number" name="phone_number" value="{{ employee.phone_number }}">
                    </div>
                    <div class="form-group">
                        <label for="dob">Birthday</label>
                        <input type="date" class="form-control" id="dob" name="dob" value="{{ employee.dob|date:'Y-m-d' }}">
                    </div>
                    <div class="form-group">
                        <label for="current_address">Address</label>
                        <input type="text" class="form-control" id="current_address" name="current_address" value="{{ employee.current_address }}">
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select class="form-control" id="gender" name="gender" >
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>

                <div class="form-group">
                    <label for="ProfileImage">Profile Image <span class="text-danger small">(Image size: Max 2MB)</span></label>
                    <input type="file" class="form-control" id="ProfileImage" name="image" >
                    <span class="text-danger small">Allowed formats: PNG and JPG.</span>
                </div>


                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>

                  </div>

              </div>
          </div>
      </div>

            <!--Modal for personal details -->
            <div class="modal fade" id="PersonaleditModal" tabindex="-1" role="dialog" aria-labelledby="editPersonalInfoLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg" role="document">
                <form method="POST" id="personal-info-form">
                  {% csrf_token %}
                  <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                      <h5 class="modal-title" id="editPersonalInfoLabel">Edit Personal Information</h5>
                      <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label>Passport</label>
                          <input type="text" class="form-control" name="passport" value="{{ personalDetails.passport }}">
                        </div>
                        <div class="form-group col-md-6">
                          <label>Passport No.</label>
                          <input type="text" class="form-control" name="passport_number" value="{{ personalDetails.passport_number  }}">
                        </div>
                      </div>
                      <div class="form-row">
                        <div class="form-group col-md-6">
                          <label>Phone</label>
                          <input type="text" class="form-control" name="phone_number" value="{{ personalDetails.Tell_number }}">
                        </div>
                        <div class="form-group col-md-6">
                          <label>Religion</label>
                          <input type="text" class="form-control" name="religion" value="{{ personalDetails.religion }}">
                        </div>
                        <div class="form-group col-md-6">
                          <label>Marital Status</label>
                          <input type="text" class="form-control" name="marital_status" value="{{ personalDetails.marital_status }}">
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="submit" class="btn btn-primary">Save</button>
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!--Modal for Emergency Contact-->
            <div class="modal fade" id="editAdditionalInfoModal" tabindex="-1" role="dialog" aria-labelledby="editEmergencyContactLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg" role="document">
         <form method="POST" action="{% url 'update_emergency_contact' employee.id %}" id="emergencyForm">
              {% csrf_token %}
              <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                  <h5 class="modal-title">Edit Emergency Contact</h5>
                  <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                  <h6>Primary Contact</h6>
                  <div class="form-row">
                    <div class="form-group col-md-4">
                      <label>Name</label>
                      <input type="text" class="form-control" name="primary_contact_name" value="{{ primary_contact.name|default_if_none:'' }}">
                    </div>
                    <div class="form-group col-md-4">
                      <label>Relationship</label>
                      <input type="text" class="form-control" name="primary_contact_relationship" value="{{ primary_contact.relationship|default_if_none:'' }}">
                    </div>
                    <div class="form-group col-md-4">
                      <label>Phone</label>
                      <input type="text" class="form-control" name="primary_contact_phone" value="{{ primary_contact.phone_number|default_if_none:'' }}">
                    </div>
                  </div>
                  <h6>Secondary Contact</h6>
                  <div class="form-row">
                    <div class="form-group col-md-4">
                      <label>Name</label>
                      <input type="text" class="form-control" name="secondary_contact_name" value="{{ secondary_contact.name|default_if_none:'' }}">
                    </div>
                    <div class="form-group col-md-4">
                      <label>Relationship</label>
                      <input type="text" class="form-control" name="secondary_contact_relationship" value="{{ secondary_contact.relationship|default_if_none:'' }}">
                    </div>
                    <div class="form-group col-md-4">
                      <label>Phone</label>
                      <input type="text" class="form-control" name="secondary_contact_phone" value="{{ secondary_contact.phone_number|default_if_none:'' }}">
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-secondary">Save</button>
                  <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
                </div>
              </div>
            </form>

              </div>
            </div>


            <!--Modal for bank information-->
            <div class="modal fade" id="editBankModal" tabindex="-1" role="dialog" aria-labelledby="editBankInfoLabel" aria-hidden="true">
              <div class="modal-dialog" role="document">
           <form method="POST" action="{% url 'update_bank_info' employee.id %}" id="bankForm">
              {% csrf_token %}
              <div class="modal-content">
                <div class="modal-header bg-success text-white">
                  <h5 class="modal-title">Edit Bank Information</h5>
                  <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                  <!-- Placeholder for success/error messages -->
                  <div id="formMessages"></div>

                  <div class="form-group">
                    <label>Bank Name</label>
                    <input type="text" class="form-control" name="bank_name" value="{{ bank_details.bank_name|default:'' }}">
                  </div>
                  <div class="form-group">
                    <label>Account Number</label>
                    <input type="text" class="form-control" name="account_no" value="{{ bank_details.bank_account_no|default:'' }}">
                  </div>
                  <div class="form-group">
                    <label>IFSC Code</label>
                    <input type="text" class="form-control" name="ifsc_code" value="{{ bank_details.ifsc_code|default:'' }}">
                  </div>
                  <div class="form-group">
                    <label>PAN Number</label>
                    <input type="text" class="form-control" name="pan_no" value="{{bank_details.pan_no|default:'' }}">
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-success">Save</button>
                  <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
                </div>
              </div>
            </form>

              </div>
            </div>


            <!--Modal for education-->
            <div class="modal fade" id="editEducationModal" tabindex="-1" role="dialog" aria-labelledby="editEducationLabel" aria-hidden="true">
              <div class="modal-dialog" role="document">
           <form method="POST" action="{% url 'update_education' employee.id %}" id="educationForm">
              {% csrf_token %}
              <div class="modal-content">
                <div class="modal-header bg-warning">
                  <h5 class="modal-title">Edit Education</h5>
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body" id="educationFormMessages">
                  <div class="form-group">
                    <label>College Name</label>
                    <input type="text" class="form-control" name="college" value="{{Edu.institution_name}}">
                  </div>
                  <div class="form-group">
                    <label>Branch</label>
                    <input type="text" class="form-control" name="branch" value="{{Edu.branch}}">
                  </div>
                  <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" class="form-control" name="start_date" value="{{Edu.start_date}}">
                  </div>
                  <div class="form-group">
                    <label>End Date</label>
                    <input type="date" class="form-control" name="end_date" value="{{Edu.end_date}}">
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="submit" class="btn btn-warning">Save</button>
                </div>
              </div>
            </form>

              </div>
            </div>



                <!--Modal for Experience-->
            <div class="modal fade" id="editExperienceModal" tabindex="-1" role="dialog">
              <div class="modal-dialog" role="document">
                <form method="POST" action="{% url 'update_experience' employee.id %}" id="experienceForm">
                  {% csrf_token %}
                  <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                      <h5 class="modal-title">Edit Experience</h5>
                      <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                    </div>

                    <div class="modal-body" id="experienceContainer">
                      <div id="extraExperienceContainer">
                        {% for exp in experiences %}
                        <div class="experience-entry border p-2 mb-2 rounded bg-light position-relative">
                          {% if forloop.first %}
                          <strong class="text-primary">Primary Experience</strong>
                          {% endif %}
                          <div class="form-group">
                            <label>Company</label>
                            <input type="text" class="form-control" name="company_{{ forloop.counter }}" value="{{ exp.company_name }}">
                          </div>
                          <div class="form-group">
                            <label>Position</label>
                            <input type="text" class="form-control" name="position_{{ forloop.counter }}" value="{{ exp.position }}">
                          </div>
                          <div class="form-row">
                            <div class="form-group col">
                              <label>Start Date</label>
                              <input type="date" class="form-control" name="start_date_{{ forloop.counter }}" value="{{ exp.start_date|date:'Y-m-d' }}">
                            </div>
                            <div class="form-group col">
                              <label>End Date</label>
                              <input type="date" class="form-control" name="end_date_{{ forloop.counter }}" value="{{ exp.end_date|date:'Y-m-d' }}">
                            </div>
                          </div>

                          {% if not forloop.first %}
                          <!-- Remove button (not shown for first entry) -->
                          <button type="button" class="btn btn-danger btn-sm remove-experience-btn position-absolute" style="top: 10px; right: 10px;">&minus;</button>
                          {% endif %}
                        </div>
                        {% endfor %}
                      </div>

                      <!-- Add Experience Button -->
                      <button type="button" class="btn btn-sm btn-success mt-2" id="addExperienceBtn">+ Add Experience</button>
                    </div>

                    <div class="modal-footer">
                      <button type="submit" class="btn btn-danger">Save</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

<!-- jQuery and Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    $(document).ready(function () {
        // When any tab link is clicked
        $('a[data-toggle="tab"]').on('click', function () {
            // Hide the card with id 'close'
            $('#activity').hide();
        });
    });
</script>

<!--Script for download table-->
<script>
  function downloadTableAsCSV(tableId) {
    const table = document.getElementById(tableId);
    let csv = [];

    // Loop through each row of the table
    for (let row of table.rows) {
      let rowData = [];

      // Loop through each cell in the row
      for (let cell of row.cells) {
        // Handle commas in cell content
        rowData.push('"' + cell.innerText.replace(/"/g, '""') + '"');
      }
      csv.push(rowData.join(','));
    }

    // Get the name based on the tableId
    let tableName = tableId.toLowerCase();
    let fileName = tableName + ".csv";

    // Create and trigger the download link
    let csvContent = csv.join('\n');
    let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    link.style.display = "none";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>

<!--Script for Showing error and submit Personal detail form-->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("#personal-info-form");
    const errorContainer = document.querySelector("#error-container");

    form.addEventListener("submit", function (e) {
        e.preventDefault();

        // Clear previous errors
        if (errorContainer) {
            errorContainer.innerHTML = '';
        }
        form.querySelectorAll(".text-danger").forEach(el => el.remove());

        const formData = new FormData(form);

        fetch("{% url 'update_personal_info' employee.id %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'error') {
                for (const [field, error] of Object.entries(data.errors)) {
                    const fieldElement = form.querySelector(`[name="${field}"]`);
                    if (fieldElement) {
                        const errorMessage = document.createElement("div");
                        errorMessage.classList.add("text-danger");
                        errorMessage.textContent = error;
                        fieldElement.parentElement.appendChild(errorMessage);
                    }
                }
            } else if (data.status === 'success') {
                // Show a short success message
                const successDiv = document.createElement("div");
                successDiv.className = "alert alert-success";
                successDiv.textContent = data.message;
                form.prepend(successDiv);

                // Close modal after delay (optional)
                setTimeout(() => {
                    successDiv.remove();
                    $('#PersonaleditModal').modal('hide');
                     location.reload();
                }, 2000);
            }
        })
        .catch(err => {
            console.error("Fetch error:", err);
        });
    });
});
</script>


<!--Script for Showing error and submit About me detail form-->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("editForm");

    if (form) {
        form.addEventListener("submit", function (e) {
            e.preventDefault();
            console.log("Submitting...");

            // Clear previous errors
            form.querySelectorAll(".text-danger").forEach(el => el.remove());

            const formData = new FormData(form);
            const actionUrl = form.getAttribute("action");

            fetch(actionUrl, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log("Response:", data);

                if (data.status === "error") {
                    // Display error messages
                    for (const [field, error] of Object.entries(data.errors)) {
                        const fieldElement = form.querySelector(`[name=${field}]`);
                        if (fieldElement) {
                            const errorDiv = document.createElement("div");
                            errorDiv.className = "text-danger mt-1";
                            errorDiv.textContent = error;
                            fieldElement.parentElement.appendChild(errorDiv);
                        }
                    }
                } else if (data.status === "success") {
                    // Display success message
                    const successMsg = document.createElement("div");
                    successMsg.className = "alert alert-success";
                    successMsg.textContent = data.message;
                    form.prepend(successMsg);

                    setTimeout(() => {
                        successMsg.remove();
                        $('#AboutMeModal').modal('hide');
                        location.reload(); // Reload to reflect changes
                    }, 2000);
                }
            })
            .catch(error => console.error("AJAX error:", error));
        });
    }
});

</script>

<!--Script for Showing error and submit Emergency Contact detail form-->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("emergencyForm");

    if (form) {
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            // Remove previous error messages
            form.querySelectorAll(".text-danger").forEach(el => el.remove());

            const formData = new FormData(form);
            const actionUrl = form.getAttribute("action");

            fetch(actionUrl, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "error") {
                    // Display field errors
                    for (const [field, message] of Object.entries(data.errors)) {
                        const fieldElement = form.querySelector(`[name=${field}]`);
                        if (fieldElement) {
                            const errorDiv = document.createElement("div");
                            errorDiv.className = "text-danger mt-1";
                            errorDiv.textContent = message;
                            fieldElement.parentElement.appendChild(errorDiv);
                        }
                    }
                } else if (data.status === "success") {
                    // Show success message
                    const successDiv = document.createElement("div");
                    successDiv.className = "alert alert-success";
                    successDiv.textContent = data.message;
                    form.parentElement.prepend(successDiv);

                    setTimeout(() => {
                        successDiv.remove();
                        $('#editAdditionalInfoModal').modal('hide');
                        location.reload(); // Optional: reload page to reflect changes
                    }, 2000);
                }
            })
            .catch(error => {
                console.error("AJAX error:", error);
            });
        });
    }
});
</script>

<!--Script for Showing error and submit Bank detail form-->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("bankForm");

    if (form) {
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            // Clear existing errors
            form.querySelectorAll(".text-danger").forEach(el => el.remove());

            const formData = new FormData(form);
            const actionUrl = form.getAttribute("action");

            fetch(actionUrl, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value
                }
            })
            .then(response => response.json())
            .then(data => {
                const messageBox = document.getElementById("formMessages");
                messageBox.innerHTML = "";

                if (data.status === "error" && data.errors) {
                    for (const [field, msg] of Object.entries(data.errors)) {
                        const input = form.querySelector(`[name="${field}"]`);
                        if (input) {
                            const err = document.createElement("div");
                            err.className = "text-danger mt-1";
                            err.textContent = msg;
                            input.parentElement.appendChild(err);
                        }
                    }
                } else if (data.status === "success") {
                    const successMsg = document.createElement("div");
                    successMsg.className = "alert alert-success";
                    successMsg.textContent = data.message;
                    messageBox.appendChild(successMsg);

                    setTimeout(() => {
                        $('#bankModal').modal('hide');
                        location.reload();
                    }, 1500);
                }
            })
            .catch(error => {
                console.error("AJAX error:", error);
            });
        });
    }
});
</script>

<!--Script for Showing error and Education detail form-->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("educationForm");

    if (form) {
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            // Clear previous errors
            form.querySelectorAll(".text-danger").forEach(el => el.remove());

            const formData = new FormData(form);
            const actionUrl = form.getAttribute("action");
            const messageContainer = document.getElementById("educationFormMessages");

            fetch(actionUrl, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "error") {
                    if (data.errors) {
                        for (const [field, msg] of Object.entries(data.errors)) {
                            const input = form.querySelector(`[name="${field}"]`);
                            if (input) {
                                const err = document.createElement("div");
                                err.className = "text-danger mt-1";
                                err.textContent = msg;
                                input.parentElement.appendChild(err);
                            }
                        }
                    } else if (data.message) {
                        const msg = document.createElement("div");
                        msg.className = "alert alert-danger";
                        msg.textContent = data.message;
                        messageContainer.prepend(msg);
                    }
                } else if (data.status === "success") {
                    const msg = document.createElement("div");
                    msg.className = "alert alert-success";
                    msg.textContent = data.message;
                    messageContainer.prepend(msg);

                    setTimeout(() => {
                        $('#educationModal').modal('hide');
                        location.reload();
                    }, 1500);
                }
            })
            .catch(error => {
                console.error("AJAX error:", error);
            });
        });
    }
});
</script>



<!--Script for Showing error and Experience detail form-->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("experienceForm");

    if (form) {
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            // Remove previous errors
            form.querySelectorAll(".text-danger").forEach(el => el.remove());

            const formData = new FormData(form);
            const actionUrl = form.getAttribute("action");

            fetch(actionUrl, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "error") {
                    for (const [field, message] of Object.entries(data.errors)) {
                        const fieldElement = form.querySelector(`[name="${field}"]`);
                        if (fieldElement) {
                            const errorDiv = document.createElement("div");
                            errorDiv.className = "text-danger mt-1";
                            errorDiv.textContent = message;
                            fieldElement.parentElement.appendChild(errorDiv);
                        }
                    }
                } else if (data.status === "success") {
                    const successDiv = document.createElement("div");
                    successDiv.className = "alert alert-success";
                    successDiv.textContent = data.message;
                    form.parentElement.prepend(successDiv);

                    setTimeout(() => {
                        successDiv.remove();
                        $('#editExperienceModal').modal('hide');
                        location.reload();
                    }, 2000);
                }
            })
            .catch(error => console.error("AJAX error:", error));
        });
    }

    // Dynamically add new experience entries
 let experienceCount = {{ experiences|length }};

  const container = document.getElementById("extraExperienceContainer");
  const addBtn = document.getElementById("addExperienceBtn");

  // Add new experience block
  addBtn.addEventListener("click", function () {
    experienceCount++;
    const newBlock = document.createElement("div");
    newBlock.classList.add("experience-entry", "border", "p-2", "mb-2", "rounded", "bg-light", "position-relative");
    newBlock.innerHTML = `
      <div class="form-group">
        <label>Company</label>
        <input type="text" class="form-control" name="company_${experienceCount}">
      </div>
      <div class="form-group">
        <label>Position</label>
        <input type="text" class="form-control" name="position_${experienceCount}">
      </div>
      <div class="form-row">
        <div class="form-group col">
          <label>Start Date</label>
          <input type="date" class="form-control" name="start_date_${experienceCount}">
        </div>
        <div class="form-group col">
          <label>End Date</label>
          <input type="date" class="form-control" name="end_date_${experienceCount}">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm remove-experience-btn position-absolute" style="top: 10px; right: 10px;">&minus;</button>
    `;
    container.appendChild(newBlock);
  });

  // Remove experience block (event delegation)
  container.addEventListener("click", function (e) {
    if (e.target.classList.contains("remove-experience-btn")) {
      const entry = e.target.closest(".experience-entry");
      if (entry) {
        entry.remove();
      }
    }
  });
});
</script>




<!--Script for Showing error and Document form-->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("uploadDocumentForm");

    if (form) {
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            // Clear previous messages and errors
            document.getElementById("uploadMessages").innerHTML = "";
            form.querySelectorAll(".text-danger").forEach(el => el.remove());

            const formData = new FormData(form);
            const actionUrl = form.getAttribute("action");
            const messageContainer = document.getElementById("uploadMessages");

            fetch(actionUrl, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": form.querySelector("[name=csrfmiddlewaretoken]").value
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === "error") {
                    if (data.errors) {
                        for (const [field, msg] of Object.entries(data.errors)) {
                            const input = form.querySelector(`[name="${field}"]`);
                            if (input) {
                                const error = document.createElement("div");
                                error.className = "text-danger mt-1";
                                error.textContent = msg;
                                input.parentElement.appendChild(error);
                            }
                        }
                    } else if (data.message) {
                        const msg = document.createElement("div");
                        msg.className = "alert alert-danger";
                        msg.textContent = data.message;
                        messageContainer.appendChild(msg);
                    }
                } else if (data.status === "success") {
                    const msg = document.createElement("div");
                    msg.className = "alert alert-success";
                    msg.textContent = data.message;
                    messageContainer.appendChild(msg);

                    // Remove the success message after 2 seconds
                    setTimeout(() => {
                        msg.remove();  // Hide message
                        const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
                        modal.hide();
                        location.reload();
                    }, 2000);
                }
            })
            .catch(error => {
                const msg = document.createElement("div");
                msg.className = "alert alert-danger";
                msg.textContent = "Upload failed. Please try again.";
                messageContainer.appendChild(msg);
                console.error("Upload error:", error);
            });
        });
    }
});
</script>

<!--Show Employee Leave details-->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const employeeInfo = document.getElementById('employee-info');
    const leaveInfo = document.getElementById('leave-info');

    // Listen to all tab clicks
    document.querySelectorAll('.nav-link').forEach(tab => {
      tab.addEventListener('click', function () {
        const target = this.getAttribute('href');

        if (target === '#leave') {
          employeeInfo.classList.add('d-none');
          leaveInfo.classList.remove('d-none');
        } else {
          employeeInfo.classList.remove('d-none');
          leaveInfo.classList.add('d-none');
        }
      });
    });
  });
</script>
<script>
    $(document).ready(function () {
        // Hide all tabs content initially
        $('.tab-pane').hide();

        // Show the active tab content on tab click
        $('a[data-toggle="tab"]').on('click', function (e) {
            var targetTab = $(this).attr('href');
            // Hide all content
            $('.tab-pane').hide();
            // Show the clicked tab content
            $(targetTab).show();
        });

        // Trigger click on the first tab to load the first content
        $('a[data-toggle="tab"]').first().click();
    });
</script>

{% endblock %}