{% extends 'base.html' %}
{% load static %}
{% block title %}Upload Payroll CSV{% endblock %}

{% block content %}
{% include 'Side_Navbar.html' %}

<div class="content-wrapper bg-light min-vh-100 py-4">
  <!-- Breadcrumb -->
  <div class="container-fluid mb-3">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-white shadow-sm px-3 py-2 rounded">
        <li class="breadcrumb-item"><a href="#" class="text-primary">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">PaySlip</li>
      </ol>
    </nav>
  </div>

<div class="container py-4">


    <form id="emailForm">
    {% csrf_token %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Payslip</h4>
        <button type="submit" class="btn btn-success" id="emailSelected">Email Payslip</button>
    </div>



    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Pdf</th>
                        <th scope="col">Month</th>
                        <th scope="col">Creation date</th>
                        <th scope="col" class="text-end">Select</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payroll in payrolls %}
                    <tr>
                        <td class="d-flex align-items-center">
                       <img src="https://cdn-icons-png.flaticon.com/512/337/337946.png" alt="PDF" class="img-fluid" style="width: 20px;">

                            <a href="/media/pdf/{{ payroll.employee_email }}{{ payroll.payroll_month|date:'Y-m-d'  }}.pdf" class="text-decoration-none" target="_blank">
                                {{ payroll.employee_email }}{{ payroll.payroll_month|date:'Y-m-d' }}.pdf
                            </a>
                        </td>
                        <td>{{ payroll.payroll_month|date:'M, Y' }}</td>
                        <td>{{ payroll.created_at|date:'M. j, Y, P' }}</td>
                        <td class="text-center">
                                     <input type="checkbox" name="selected_emails" value="{{ payroll.employee_email }}||{{ payroll.payroll_month|date:'Y-m-d' }}">
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No payslips found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    </form>
</div>

</div>

<script>
document.getElementById("emailForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const checkboxes = document.querySelectorAll('input[name="selected_emails"]:checked');
    const selected = Array.from(checkboxes).map(cb => cb.value);

    if (selected.length === 0) {
        alert("Please select at least one payslip.");
        return;
    }

    fetch("{% url 'send_selected_payslips' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({ selected: selected })
    })
    .then(response => response.json())
    .then(data => alert(data.message))
    .catch(error => alert("Error sending emails."));
});
</script>

{% endblock %}